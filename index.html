<!doctype html>
<html>
<head>
  <title>Web ChatApp</title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <!-- jQuery library -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <!-- Latest compiled JavaScript -->
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <!--   <link rel="stylesheet" href="css/reset.css" type="text/css">
      <link rel="stylesheet" type="text/css" href="D:/ChatApp/bootstrap/css/bootstrap.css">
      <link rel="stylesheet" type="text/css" href="D:/ChatApp/bootstrap/css/bootstrap-theme.min.css">
      <script src="D:/ChatApp/bootstrap/js/bootstrap.js"></script> -->
      <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font: 13px Helvetica, Arial; background: url('https://d26a57ydsghvgx.cloudfront.net/content/blog/live_chat.png'); background-repeat: no-repeat; background-size: cover; }
      form {  width:30%; padding: 5%;  }
      form input { border: 0; padding: 10px;  margin-right: .5%; }
      form button { background: rgb(130, 224, 255); border: none; padding: 10px; }
      #d {border: none; padding: 10px; width: 60%}
      #btn { background: rgb(130, 224, 255); border: none; padding: 10px; }
      #message-container { overflow: auto; max-height: 40vh; list-style-type: none; margin: 0; padding: 0;  }
      #message-container li {  background: #eee;   padding: 5%}
      /*#message-container li:nth-child(odd) { background: #eee;  padding: 5%;}*/
      #message-container p {font: Arial; font-size: 1.5vh; text-align: right; color: #fff }

    </style>

  </head>

  <body>
    <!-- <ul id="messages"></ul> -->
    <!-- <form action=""> -->
     <!-- onchange="changing()" on input-->
     <!-- <input id="m" autocomplete="off" /><button>Send</button> -->
     <!-- </form> -->
     <!-- action="/pictures/upload" method="POST" enctype="multipart/form-data" -->
     <form>
      <input id="name" type="text" name="name" value="" placeholder="Enter your username!">
      <button type="button" name="button" onclick="setUsername()">Let me chat!</button>
      <div id="d">
        <input type="file" name="image" id="image"> 
        <!-- <input id = "uploadbtn" type="submit" value="Upload your image"> -->
      </div>
    </form>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      var socket = io();
      function setUsername(){
        var usern = document.getElementById('name').value;
        var unl = document.getElementById('name').value.length;
      // var avatar = document.getElementById('uploadbtn').value;
      var img = document.getElementById('image').value;
      var imgl = document.getElementById('image').value.length;
      // console.log(avatar);
      // console.log(img);
      var pattern = new RegExp(/[^a-zA-Z]/);
      var check = pattern.test(usern); //returns false if it contains only characters (I guess it is toggeled)
      var check0 = (unl == 0);
      var check1 = (imgl == 0);
      var check2 = (check && check0 && !check1);  
      if(check0){
        alert("username is supposed to have a value");
      } else {
        if(check) {
          alert("username is only characters");
        } else {
          if (check1) {
            alert("please upload a photo to proceed")
          } else {
            // var chatroom = { username: usern, avatar: img};
            socket.emit('setUsername', document.getElementById('name').value); 
          }
        }
      }
      // if (check2) {
      //   alert("Username must not be empty, and only contain letters.");
      // } else {
      //   socket.emit('setUsername', document.getElementById('name').value);
      // }
    };
    var user;
    socket.on('userExists', function(data){
      document.getElementById('error-container').innerHTML = data;
    });
    socket.on('userSet', function(data){
      user = document.getElementById('name').value;
      document.body.innerHTML = '<form><input type="text" id="message">\
      <button type="button" name="button" onclick="sendMessage()">Send</button>\
      <div id="message-container"></div></form>';
    });
    function sendMessage(){
      var msg = document.getElementById('message').value;
      if(msg){
        // alert("You got a new message.");
        socket.emit('msg', {message: msg});
      } else {
        alert("You can not send an empty message.");
      }
    }
    socket.on('newmsg', function(data){
      var today = new Date;
    // today = today.toDateString();
    y = today.getFullYear();
    m = today.getMonth() + 1;
    d = today.getDate();
    var h = today.getHours();
    if (h == 0) 
      h = "0" + h;
    var mm = today.getMinutes();
    if(mm < 10)
      mm = "0" + mm;

    
    if(user){
        // document.getElementById('message-container').innerHTML += '<div> <ul id="messages"> <li> <b>' + data.user + '</b>: ' + data.message + '</li> </ul> </div>'
        // white-space: pre-line;        -00
        $('#message-container').append($('<li>').text(user + ": " + data.message));    
        // $('#message-container').append($('<li id="msg">').text(data.message));
        // $('#message-container').append($('<li>').text(data.user + ": " + data.message + "\n" + d + "/" + m + "/" + y+ " " + h + ":" + mm));
        $('#message-container').append($('<p>').text(d + "/" + m + "/" + y+ " " + h + ":" + mm));
        var objDiv = document.getElementById('message-container');
        objDiv.scrollTop = objDiv.scrollHeight;
      }
    })

  </script>
  <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
  <div id="error-container"></div>
  
</body>
</html>

<!--
 <input id="name" type="text" name="name" value="" onchange="changing()" placeholder="Enter your username!">
  <button type="button" name="button" onclick="setUsername()">Let me chat!</button>
 
  <script>
    var socket = io();
    socket.on('connectToRoom',function(data){
      document.body.innerHTML = '';
      document.write(data);
    });
  </script> 
  <script>
    $(function () {
      var socket = io();
      $('form').submit(function(){
        socket.emit('chat message', $('#m').val());
        $('#m').val('');
        return false;
      });
      socket.on('chat message', function(msg){
        $('#messages').append($('<li>').text(msg));
      });
    });
  </script> -->